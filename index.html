<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>ThermoLog Pro - VR Edition</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- A-Frame for VR -->
    <script src="https://aframe.io/releases/1.5.0/aframe.min.js"></script>
    <script src="https://unpkg.com/aframe-environment-component@1.3.3/dist/aframe-environment-component.min.js"></script>
    
    <script type="importmap">
      {
        "imports": {
          "@google/genai": "https://esm.sh/@google/genai",
          "chart.js/auto": "https://esm.sh/chart.js@4.4.2/auto",
          "lucide": "https://esm.sh/lucide@0.344.0"
        }
      }
    </script>
    <style>
      .custom-scrollbar::-webkit-scrollbar {
        width: 8px;
        height: 8px;
      }
      .custom-scrollbar::-webkit-scrollbar-track {
        background: #1e293b;
      }
      .custom-scrollbar::-webkit-scrollbar-thumb {
        background: #475569;
        border-radius: 4px;
      }
      .custom-scrollbar::-webkit-scrollbar-thumb:hover {
        background: #64748b;
      }
      @keyframes slideIn {
        from { opacity: 0; transform: translateY(20px); }
        to { opacity: 1; transform: translateY(0); }
      }
      .slide-in {
        animation: slideIn 0.5s ease-out forwards;
      }
      
      /* VR Toggle Helper Classes */
      .vr-active #app-2d {
        /* Move off-screen instead of display:none to keep canvas rendering for texture */
        position: absolute;
        left: -9999px;
        opacity: 0;
        pointer-events: none;
      }
      .vr-active #app-vr {
        display: block;
      }
      #app-vr {
        display: none; /* Hidden by default */
        position: absolute;
        top: 0; left: 0; width: 100%; height: 100%;
        z-index: 100;
      }
    </style>
  <link rel="stylesheet" href="/index.css">
</head>
  <body class="bg-slate-950 text-slate-200 antialiased min-h-screen w-full flex flex-col font-sans">
    
    <!-- 2D Application Container -->
    <div id="app-2d" class="flex flex-col min-h-screen w-full transition-opacity duration-300">
        <!-- Navbar -->
        <nav class="sticky top-0 z-50 w-full bg-slate-900/95 backdrop-blur border-b border-slate-800 px-4 py-3 shadow-md">
          <div class="max-w-7xl mx-auto flex items-center justify-between">
              <div class="flex items-center gap-3">
                  <div class="bg-blue-600 p-2 rounded-lg shadow-lg shadow-blue-900/50">
                      <i data-lucide="database" class="text-white w-5 h-5"></i>
                  </div>
                  <div>
                      <h1 class="text-lg md:text-xl font-bold tracking-tight text-white leading-tight">
                          ThermoLog <span class="text-blue-500">Pro</span>
                      </h1>
                  </div>
              </div>
              
              <div class="flex items-center gap-4">
                   <!-- VR Toggle Button -->
                   <button id="btn-enter-vr" class="flex items-center gap-2 px-3 py-1.5 bg-indigo-600 hover:bg-indigo-500 text-white rounded-lg transition-colors text-xs font-bold uppercase tracking-wider shadow-lg shadow-indigo-900/50">
                      <i data-lucide="glasses" class="w-4 h-4"></i>
                      <span>Enter VR Lab</span>
                   </button>

                   <div class="flex items-center gap-2 px-3 py-1.5 bg-slate-950 rounded-full border border-slate-800">
                      <div id="status-indicator" class="w-2 h-2 rounded-full bg-slate-500 transition-colors duration-300"></div>
                      <span id="status-text" class="text-xs font-mono font-medium text-slate-400">READY</span>
                   </div>
              </div>
          </div>
        </nav>

        <!-- Main Content -->
        <main class="flex-grow w-full max-w-7xl mx-auto p-4 md:p-6 lg:p-8 space-y-6">
          
          <!-- Sensor Readouts -->
          <section class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <!-- Ambient -->
            <div class="bg-slate-900 border border-slate-700 rounded-xl p-6 relative overflow-hidden shadow-lg">
              <div class="absolute top-0 right-0 p-4 opacity-10">
                <i data-lucide="thermometer" class="w-32 h-32"></i>
              </div>
              <div class="relative z-10">
                <h2 class="text-slate-400 text-sm font-semibold uppercase tracking-wider mb-1">Ambient Temperature</h2>
                <div class="flex items-baseline gap-2">
                  <span id="val-ambient" class="text-5xl font-mono font-bold text-emerald-400">24.00</span>
                  <span class="text-xl text-slate-500">°C</span>
                </div>
                <div class="mt-2 text-xs text-slate-500 font-mono">SENSOR_ID: AMB_01 • STATUS: OK</div>
              </div>
            </div>
            <!-- Thermopile -->
            <div class="bg-slate-900 border border-slate-700 rounded-xl p-6 relative overflow-hidden shadow-lg">
              <div class="absolute top-0 right-0 p-4 opacity-10">
                <i data-lucide="zap" class="w-32 h-32"></i>
              </div>
              <div class="relative z-10">
                <h2 class="text-slate-400 text-sm font-semibold uppercase tracking-wider mb-1">Thermopile Reading</h2>
                <div class="flex items-baseline gap-2">
                  <span id="val-voltage" class="text-5xl font-mono font-bold text-blue-400 transition-colors duration-300">0.500</span>
                  <span class="text-xl text-slate-500">mV</span>
                </div>
                <div class="mt-2 text-xs text-slate-500 font-mono">SENSOR_ID: TP_v2 • GAIN: 100x</div>
              </div>
            </div>
          </section>

          <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 lg:gap-8 items-start">
              
              <!-- Left Column: Chart & Analysis -->
              <div class="lg:col-span-2 space-y-6">
                  
                  <!-- Chart Card -->
                  <div class="bg-slate-900 border border-slate-800 rounded-xl p-4 shadow-xl overflow-hidden flex flex-col h-[400px] md:h-[500px]">
                      <h3 class="text-slate-400 text-xs font-semibold uppercase tracking-wider mb-2">Live Sensor Telemetry</h3>
                      <div class="relative flex-grow w-full min-h-0">
                          <!-- Canvas ID used for VR Texture -->
                          <canvas id="sensorChart"></canvas>
                      </div>
                  </div>

                  <!-- AI Analysis Result (Hidden by default) -->
                  <div id="analysis-container" class="hidden bg-slate-900 border border-indigo-900/50 rounded-xl p-5 shadow-xl slide-in">
                      <div class="flex items-center gap-2 mb-4 text-indigo-400 border-b border-indigo-900/30 pb-2">
                          <i data-lucide="terminal" class="w-5 h-5"></i>
                          <h3 class="font-bold text-sm uppercase tracking-wider">AI Analysis Report</h3>
                      </div>
                      <div id="analysis-text" class="bg-slate-950 rounded-lg p-4 border border-slate-800 font-mono text-sm text-slate-300 whitespace-pre-wrap leading-relaxed"></div>
                  </div>
              </div>

              <!-- Right Column: Controls & Data -->
              <div class="space-y-6">
                  
                  <!-- Control Panel -->
                  <div class="bg-slate-900 border border-slate-700 p-4 rounded-xl shadow-lg flex flex-col gap-6">
                    <!-- Logger Control -->
                    <div>
                      <h3 class="text-slate-400 text-xs font-semibold uppercase tracking-wider mb-3">Logger Control</h3>
                      <div class="grid grid-cols-2 gap-2">
                        <button id="btn-record" class="flex items-center justify-center gap-2 p-3 rounded-lg font-medium bg-emerald-500/10 text-emerald-400 hover:bg-emerald-500/20 border border-emerald-500/50 transition-all">
                          <i data-lucide="play" class="w-4 h-4"></i> <span id="btn-record-text">Start Log</span>
                        </button>
                        <button id="btn-clear" class="flex items-center justify-center gap-2 p-3 rounded-lg font-medium bg-slate-800 text-slate-400 hover:bg-slate-700 hover:text-white transition-all border border-slate-700">
                          <i data-lucide="trash-2" class="w-4 h-4"></i> Clear
                        </button>
                      </div>
                      <div class="mt-2 text-center">
                          <span id="data-count" class="text-xs text-slate-500 font-mono">0 Data Points Recorded</span>
                      </div>
                    </div>

                    <hr class="border-slate-800" />

                    <!-- Simulation Config -->
                    <div>
                      <h3 class="text-slate-400 text-xs font-semibold uppercase tracking-wider mb-3 flex items-center gap-2">
                        <i data-lucide="cpu" class="w-3 h-3"></i> Simulation Config
                      </h3>
                      <div class="space-y-4">
                        <button id="btn-heat" class="w-full flex items-center justify-between p-4 rounded-lg border bg-slate-800 border-slate-700 text-slate-400 hover:bg-slate-700 transition-all">
                          <span class="flex items-center gap-2 font-medium">
                              <i id="icon-flame" data-lucide="flame" class="w-5 h-5"></i>
                              Heat Source
                          </span>
                          <span id="heat-status" class="text-xs font-mono uppercase">INACTIVE</span>
                        </button>

                        <div>
                           <div class="flex justify-between text-xs text-slate-400 mb-1">
                              <span>Signal Noise</span>
                              <span id="noise-display">10%</span>
                           </div>
                           <input id="input-noise" type="range" min="0" max="1" step="0.1" value="0.1" class="w-full h-2 bg-slate-800 rounded-lg appearance-none cursor-pointer accent-blue-500">
                        </div>
                      </div>
                    </div>

                    <hr class="border-slate-800" />

                    <!-- Tools -->
                    <div class="flex flex-col gap-2">
                       <h3 class="text-slate-400 text-xs font-semibold uppercase tracking-wider mb-1">Tools</h3>
                       <button id="btn-analyze" disabled class="flex items-center justify-center gap-2 p-3 rounded-lg font-medium bg-indigo-600 hover:bg-indigo-500 text-white transition-all disabled:opacity-50 disabled:cursor-not-allowed shadow-lg shadow-indigo-900/20">
                          <i data-lucide="activity" class="w-4 h-4"></i> <span id="btn-analyze-text">Analyze Data with AI</span>
                       </button>
                       <button id="btn-download" disabled class="flex items-center justify-center gap-2 p-3 rounded-lg font-medium bg-slate-800 text-slate-300 hover:bg-slate-700 transition-all border border-slate-700 disabled:opacity-50">
                          <i data-lucide="download" class="w-4 h-4"></i> Export CSV
                       </button>
                    </div>
                  </div>

                  <!-- Data Table -->
                  <div class="bg-slate-900 border border-slate-700 rounded-xl overflow-hidden flex flex-col shadow-xl">
                      <div class="p-4 border-b border-slate-800 bg-slate-800/50 flex justify-between items-center">
                          <h3 class="text-xs font-bold text-slate-400 uppercase tracking-wider flex items-center gap-2">
                              <i data-lucide="activity" class="w-3 h-3"></i> Live Data Log
                          </h3>
                      </div>
                      <div class="h-[400px] overflow-auto custom-scrollbar bg-slate-950">
                          <table class="w-full text-xs font-mono text-left">
                              <thead class="bg-slate-900 text-slate-500 sticky top-0 z-10 shadow-sm">
                                  <tr>
                                      <th class="p-3 pl-4">Time</th>
                                      <th class="p-3">Amb(C)</th>
                                      <th class="p-3">TP(mV)</th>
                                  </tr>
                              </thead>
                              <tbody id="data-table-body" class="divide-y divide-slate-800/50">
                                  <tr>
                                      <td colspan="3" class="p-12 text-center text-slate-600 italic">
                                          No data recorded.<br/>Press 'Start Log' to begin.
                                      </td>
                                  </tr>
                              </tbody>
                          </table>
                      </div>
                  </div>

              </div>
          </div>
        </main>
        
        <footer class="w-full py-6 text-center text-slate-600 text-xs border-t border-slate-900 mt-auto">
          <p>ThermoLog Pro v1.0 • Project 16 Virtual Data Logger • VR Ready</p>
        </footer>
    </div>

    <!-- VR APPLICATION CONTAINER (A-Frame) -->
    <div id="app-vr">
        <!-- Exit VR Button (Overlay) -->
        <div style="position: absolute; bottom: 20px; left: 50%; transform: translateX(-50%); z-index: 999; pointer-events: auto;">
             <button id="btn-exit-vr" class="bg-red-600 hover:bg-red-500 text-white px-6 py-2 rounded-full font-bold shadow-lg shadow-red-900/50 uppercase tracking-wider text-sm transition-all">
                Exit VR Lab
             </button>
        </div>

        <a-scene embedded background="color: #0f172a">
            <!-- Environment -->
            <a-entity environment="preset: tron; gridColor: #3b82f6; groundColor: #0f172a; skyType: atmosphere"></a-entity>

            <!-- Assets -->
            <a-assets>
               <canvas id="vr-chart-canvas"></canvas>
            </a-assets>

            <!-- Player Rig -->
            <a-entity id="rig" position="0 0 2">
                <a-camera look-controls wasd-controls>
                    <!-- Enhanced Cursor Ring -->
                    <a-cursor color="#4ade80" fuse="false" raycaster="objects: .interactable" scale="1.5 1.5 1.5"></a-cursor>
                </a-camera>
                <a-entity laser-controls="hand: left" raycaster="objects: .interactable; far: 10"></a-entity>
                <a-entity laser-controls="hand: right" raycaster="objects: .interactable; far: 10"></a-entity>
            </a-entity>

            <!-- Main Dashboard (Center) -->
            <a-entity position="0 1.6 -1.5" rotation="0 0 0">
                <!-- Frame -->
                <a-box position="0 0 -0.05" width="2.2" height="1.4" depth="0.05" color="#1e293b" material="roughness: 0.8"></a-box>
                <a-text value="LIVE SENSOR TELEMETRY" position="0 0.6 0.01" align="center" color="#94a3b8" width="3"></a-text>
                
                <!-- Chart Plane (Uses the 2D Canvas as texture) -->
                <!-- Note: The material src will be assigned via JS to #sensorChart -->
                <a-plane id="vr-chart-plane" position="0 -0.05 0.02" width="2" height="1.1" color="#1e293b"></a-plane>
            </a-entity>

            <!-- Left Panel: Readouts -->
            <a-entity position="-1.8 1.6 -1.2" rotation="0 25 0">
                <a-box position="0 0 -0.05" width="1.2" height="1.4" depth="0.05" color="#0f172a" material="opacity: 0.9; transparent: true"></a-box>
                <a-text value="SENSOR READOUT" position="0 0.5 0.01" align="center" color="#3b82f6" width="2.5"></a-text>
                
                <!-- Ambient -->
                <a-text value="Ambient Temp" position="0 0.2 0.01" align="center" color="#64748b" width="2"></a-text>
                <a-text id="vr-val-ambient" value="24.00 C" position="0 0 0.01" align="center" color="#34d399" width="6" font="mozillavr"></a-text>
                
                <!-- Voltage -->
                <a-text value="Thermopile (mV)" position="0 -0.3 0.01" align="center" color="#64748b" width="2"></a-text>
                <a-text id="vr-val-voltage" value="0.500" position="0 -0.5 0.01" align="center" color="#60a5fa" width="6" font="mozillavr"></a-text>
            </a-entity>

            <!-- Right Panel: Controls -->
            <a-entity position="1.8 1.6 -1.2" rotation="0 -25 0">
                 <a-box position="0 0 -0.05" width="1.2" height="1.4" depth="0.05" color="#0f172a" material="opacity: 0.9"></a-box>
                 <a-text value="CONTROL DECK" position="0 0.5 0.01" align="center" color="#f59e0b" width="2.5"></a-text>

                 <!-- Record Button -->
                 <a-box id="vr-btn-record" class="interactable" position="0 0.2 0.05" width="0.8" height="0.2" depth="0.05" color="#059669">
                     <a-text id="vr-txt-record" value="START LOG" align="center" position="0 0 0.03" width="3"></a-text>
                 </a-box>

                 <!-- Heat Button -->
                 <a-box id="vr-btn-heat" class="interactable" position="0 -0.1 0.05" width="0.8" height="0.2" depth="0.05" color="#b45309">
                     <a-text id="vr-txt-heat" value="HEAT SOURCE: OFF" align="center" position="0 0 0.03" width="3"></a-text>
                 </a-box>

                 <!-- Clear Button -->
                 <a-box id="vr-btn-clear" class="interactable" position="0 -0.4 0.05" width="0.8" height="0.2" depth="0.05" color="#475569">
                     <a-text value="CLEAR DATA" align="center" position="0 0 0.03" width="3"></a-text>
                 </a-box>
            </a-entity>

        </a-scene>
    </div>

    <!-- Logic Script -->
    <script type="module">
        import { GoogleGenAI } from "@google/genai";
        import Chart from "chart.js/auto";
        import { createIcons, Thermometer, Zap, Database, Play, Pause, Trash2, Download, Flame, Activity, Cpu, Terminal, Glasses } from "lucide";

        // --- Init Icons ---
        createIcons({
            icons: { Thermometer, Zap, Database, Play, Pause, Trash2, Download, Flame, Activity, Cpu, Terminal, Glasses }
        });

        // --- State ---
        const state = {
            isRecording: false,
            data: [],
            startTime: null,
            simulation: {
                heatSource: false,
                noise: 0.1
            },
            currentValues: {
                ambient: 24.0,
                voltage: 0.5
            }
        };

        // --- DOM Elements ---
        const els = {
            valAmbient: document.getElementById('val-ambient'),
            valVoltage: document.getElementById('val-voltage'),
            statusIndicator: document.getElementById('status-indicator'),
            statusText: document.getElementById('status-text'),
            btnRecord: document.getElementById('btn-record'),
            btnRecordText: document.getElementById('btn-record-text'),
            btnClear: document.getElementById('btn-clear'),
            btnHeat: document.getElementById('btn-heat'),
            heatStatus: document.getElementById('heat-status'),
            iconFlame: document.getElementById('icon-flame'),
            inputNoise: document.getElementById('input-noise'),
            noiseDisplay: document.getElementById('noise-display'),
            btnAnalyze: document.getElementById('btn-analyze'),
            btnAnalyzeText: document.getElementById('btn-analyze-text'),
            btnDownload: document.getElementById('btn-download'),
            dataCount: document.getElementById('data-count'),
            tableBody: document.getElementById('data-table-body'),
            analysisContainer: document.getElementById('analysis-container'),
            analysisText: document.getElementById('analysis-text'),
            
            // VR Elements
            btnEnterVr: document.getElementById('btn-enter-vr'),
            btnExitVr: document.getElementById('btn-exit-vr'),
            vrChartPlane: document.getElementById('vr-chart-plane'),
            vrValAmbient: document.getElementById('vr-val-ambient'),
            vrValVoltage: document.getElementById('vr-val-voltage'),
            vrBtnRecord: document.getElementById('vr-btn-record'),
            vrTxtRecord: document.getElementById('vr-txt-record'),
            vrBtnHeat: document.getElementById('vr-btn-heat'),
            vrTxtHeat: document.getElementById('vr-txt-heat'),
            vrBtnClear: document.getElementById('vr-btn-clear'),
        };

        // --- Chart Setup ---
        const ctx = document.getElementById('sensorChart').getContext('2d');
        const chart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: [],
                datasets: [
                    {
                        label: 'Ambient (°C)',
                        data: [],
                        borderColor: '#34d399',
                        backgroundColor: '#34d399',
                        yAxisID: 'y',
                        tension: 0.4,
                        borderWidth: 2,
                        pointRadius: 0
                    },
                    {
                        label: 'Thermopile (mV)',
                        data: [],
                        borderColor: '#60a5fa',
                        backgroundColor: '#60a5fa',
                        yAxisID: 'y1',
                        tension: 0.4,
                        borderWidth: 2,
                        pointRadius: 0
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                animation: false, 
                interaction: {
                    mode: 'index',
                    intersect: false,
                },
                plugins: {
                    legend: {
                        labels: { color: '#94a3b8', font: {family: 'monospace'} }
                    },
                    tooltip: {
                        backgroundColor: '#0f172a',
                        titleColor: '#e2e8f0',
                        bodyColor: '#e2e8f0',
                        borderColor: '#334155',
                        borderWidth: 1
                    }
                },
                scales: {
                    x: {
                        ticks: { color: '#94a3b8' },
                        grid: { color: '#334155' }
                    },
                    y: {
                        type: 'linear',
                        display: true,
                        position: 'left',
                        ticks: { color: '#34d399' },
                        grid: { color: '#334155' },
                        title: { display: true, text: 'Temp (°C)', color: '#34d399' }
                    },
                    y1: {
                        type: 'linear',
                        display: true,
                        position: 'right',
                        ticks: { color: '#60a5fa' },
                        grid: { drawOnChartArea: false },
                        title: { display: true, text: 'Voltage (mV)', color: '#60a5fa' }
                    }
                }
            }
        });

        // --- Simulation Loop ---
        const BASE_AMBIENT = 24.0;
        const BASE_VOLTAGE = 0.5;
        
        setInterval(() => {
            const now = Date.now();
            const t = now / 1000;

            // Physics calculation
            const ambientNoise = (Math.random() - 0.5) * state.simulation.noise;
            const ambientTrend = Math.sin(t * 0.1) * 0.5;
            const targetAmbient = BASE_AMBIENT + ambientTrend + ambientNoise;

            const voltageNoise = (Math.random() - 0.5) * state.simulation.noise * 0.5;
            const heatEffect = state.simulation.heatSource 
                ? 3.5 + (Math.sin(t * 5) * 0.1) 
                : 0;
            const targetVoltage = BASE_VOLTAGE + heatEffect + voltageNoise;

            // Lag effect
            state.currentValues.voltage += (targetVoltage - state.currentValues.voltage) * 0.1;
            state.currentValues.ambient = targetAmbient;

            // 2D UI Updates
            els.valAmbient.textContent = state.currentValues.ambient.toFixed(2);
            els.valVoltage.textContent = state.currentValues.voltage.toFixed(3);

            if(state.currentValues.voltage > 2.0) {
                els.valVoltage.classList.remove('text-blue-400');
                els.valVoltage.classList.add('text-amber-400');
            } else {
                els.valVoltage.classList.remove('text-amber-400');
                els.valVoltage.classList.add('text-blue-400');
            }

            // VR UI Updates
            // Only update if VR is likely active or initialized to save resources, 
            // but A-Frame properties are cheap so we do it always for simplicity.
            if(els.vrValAmbient) els.vrValAmbient.setAttribute('value', state.currentValues.ambient.toFixed(2) + " C");
            if(els.vrValVoltage) els.vrValVoltage.setAttribute('value', state.currentValues.voltage.toFixed(3) + " mV");

            // Update Chart Texture in VR
            const chartMesh = els.vrChartPlane.getObject3D('mesh');
            if (chartMesh && chartMesh.material.map) {
                chartMesh.material.map.needsUpdate = true;
            }

            // Recording Logic
            if (state.isRecording) {
                if (!state.startTime) state.startTime = now;
                const elapsedTime = (now - state.startTime) / 1000;

                const point = {
                    id: now,
                    time: elapsedTime,
                    ambient: state.currentValues.ambient,
                    voltage: state.currentValues.voltage,
                    heat: state.simulation.heatSource
                };

                state.data.push(point);

                // Update Chart
                chart.data.labels.push(elapsedTime.toFixed(1));
                chart.data.datasets[0].data.push(point.ambient);
                chart.data.datasets[1].data.push(point.voltage);

                if(chart.data.labels.length > 100) {
                    chart.data.labels.shift();
                    chart.data.datasets[0].data.shift();
                    chart.data.datasets[1].data.shift();
                }
                chart.update(); // This updates the Canvas which feeds the VR Texture

                addTableRow(point);
                updateUIState();
            }

        }, 100);

        function addTableRow(point) {
            const row = document.createElement('tr');
            row.className = "hover:bg-slate-900/50 transition-colors animate-in fade-in";
            row.innerHTML = `
                <td class="p-2 pl-4 text-slate-400">${point.time.toFixed(1)}s</td>
                <td class="p-2 text-emerald-500">${point.ambient.toFixed(1)}</td>
                <td class="p-2 text-blue-400">${point.voltage.toFixed(2)}</td>
            `;
            if (state.data.length === 1) els.tableBody.innerHTML = '';
            els.tableBody.prepend(row);
            if (els.tableBody.children.length > 50) els.tableBody.lastElementChild.remove();
        }

        function updateUIState() {
            els.dataCount.textContent = `${state.data.length} Data Points Recorded`;
            els.btnAnalyze.disabled = state.data.length === 0;
            els.btnDownload.disabled = state.data.length === 0;
        }

        // --- Core Functions ---

        function toggleRecording() {
            state.isRecording = !state.isRecording;
            
            // 2D Button Update
            if (state.isRecording) {
                els.btnRecord.classList.remove('bg-emerald-500/10', 'text-emerald-400', 'border-emerald-500/50');
                els.btnRecord.classList.add('bg-red-500/10', 'text-red-400', 'border-red-500/50');
                els.btnRecord.innerHTML = `<i data-lucide="pause" class="w-4 h-4"></i> Stop Log`;
                els.statusIndicator.classList.remove('bg-slate-500');
                els.statusIndicator.classList.add('bg-red-500', 'animate-pulse');
                els.statusText.textContent = "RECORDING";
                
                // VR Button Update
                els.vrBtnRecord.setAttribute('color', '#ef4444');
                els.vrTxtRecord.setAttribute('value', 'STOP LOG');
                
                if (state.data.length === 0) {
                    state.startTime = Date.now();
                    chart.data.labels = [];
                    chart.data.datasets.forEach(d => d.data = []);
                    chart.update();
                }
            } else {
                els.btnRecord.classList.remove('bg-red-500/10', 'text-red-400', 'border-red-500/50');
                els.btnRecord.classList.add('bg-emerald-500/10', 'text-emerald-400', 'border-emerald-500/50');
                els.btnRecord.innerHTML = `<i data-lucide="play" class="w-4 h-4"></i> Start Log`;
                els.statusIndicator.classList.remove('bg-red-500', 'animate-pulse');
                els.statusIndicator.classList.add('bg-slate-500');
                els.statusText.textContent = "STANDBY";
                
                // VR Button Update
                els.vrBtnRecord.setAttribute('color', '#059669');
                els.vrTxtRecord.setAttribute('value', 'START LOG');
            }
            createIcons({ icons: { Play, Pause }, nameAttr: 'data-lucide' });
        }

        function clearData() {
            state.isRecording = false;
            state.data = [];
            state.startTime = null;
            
            chart.data.labels = [];
            chart.data.datasets.forEach(d => d.data = []);
            chart.update();
            
            els.tableBody.innerHTML = `<tr><td colspan="3" class="p-12 text-center text-slate-600 italic">No data recorded.<br/>Press 'Start Log' to begin.</td></tr>`;
            
            els.statusIndicator.classList.remove('bg-red-500', 'animate-pulse');
            els.statusIndicator.classList.add('bg-slate-500');
            els.statusText.textContent = "READY";
            
            els.btnRecord.classList.remove('bg-red-500/10', 'text-red-400', 'border-red-500/50');
            els.btnRecord.classList.add('bg-emerald-500/10', 'text-emerald-400', 'border-emerald-500/50');
            els.btnRecord.innerHTML = `<i data-lucide="play" class="w-4 h-4"></i> Start Log`;
            createIcons({ icons: { Play }, nameAttr: 'data-lucide' });
            els.analysisContainer.classList.add('hidden');
            
            // VR Button Reset
            els.vrBtnRecord.setAttribute('color', '#059669');
            els.vrTxtRecord.setAttribute('value', 'START LOG');

            updateUIState();
        }

        function toggleHeat() {
            state.simulation.heatSource = !state.simulation.heatSource;
            // 2D Update
            if(state.simulation.heatSource) {
                els.btnHeat.classList.remove('bg-slate-800', 'border-slate-700', 'text-slate-400');
                els.btnHeat.classList.add('bg-amber-500/10', 'border-amber-500/50', 'text-amber-400', 'shadow-[0_0_15px_rgba(245,158,11,0.2)]');
                els.heatStatus.textContent = "ACTIVE";
                els.iconFlame.classList.add('animate-pulse');
                
                // VR Update
                els.vrBtnHeat.setAttribute('color', '#f59e0b');
                els.vrTxtHeat.setAttribute('value', 'HEAT SOURCE: ON');
            } else {
                els.btnHeat.classList.add('bg-slate-800', 'border-slate-700', 'text-slate-400');
                els.btnHeat.classList.remove('bg-amber-500/10', 'border-amber-500/50', 'text-amber-400', 'shadow-[0_0_15px_rgba(245,158,11,0.2)]');
                els.heatStatus.textContent = "INACTIVE";
                els.iconFlame.classList.remove('animate-pulse');
                
                // VR Update
                els.vrBtnHeat.setAttribute('color', '#b45309');
                els.vrTxtHeat.setAttribute('value', 'HEAT SOURCE: OFF');
            }
        }

        // --- Event Handlers (2D) ---
        els.btnRecord.onclick = toggleRecording;
        els.btnClear.onclick = clearData;
        els.btnHeat.onclick = toggleHeat;
        
        els.inputNoise.oninput = (e) => {
            state.simulation.noise = parseFloat(e.target.value);
            els.noiseDisplay.textContent = `${(state.simulation.noise * 100).toFixed(0)}%`;
        };

        els.btnDownload.onclick = () => {
            if(state.data.length === 0) return;
            const headers = ["Timestamp,Elapsed Time (s),Ambient Temp (C),Thermopile Voltage (mV),Heat Source"];
            const rows = state.data.map(d => 
                `${new Date(d.id).toISOString()},${d.time.toFixed(3)},${d.ambient.toFixed(3)},${d.voltage.toFixed(3)},${d.heat ? 1 : 0}`
            );
            const csvContent = "data:text/csv;charset=utf-8," + headers.concat(rows).join("\n");
            const link = document.createElement("a");
            link.setAttribute("href", encodeURI(csvContent));
            link.setAttribute("download", `thermolog_${new Date().toISOString()}.csv`);
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        };

        els.btnAnalyze.onclick = async () => {
            if(state.data.length === 0) return;
            const key = (typeof process !== 'undefined' && process.env) ? process.env.API_KEY : null;
            if (!key) {
               alert("API_KEY is missing. Please configure it in your Netlify Environment Variables.");
               return;
            }
            els.btnAnalyze.disabled = true;
            els.btnAnalyzeText.textContent = "Analyzing...";
            els.analysisContainer.classList.add('hidden');
            try {
                const MAX_POINTS = 50;
                const step = Math.ceil(state.data.length / MAX_POINTS);
                const sampledData = state.data.filter((_, index) => index % step === 0).map(d => ({
                    time: d.time.toFixed(1) + 's',
                    ambient: d.ambient.toFixed(2) + '°C',
                    thermopile: d.voltage.toFixed(2) + 'mV',
                    heat: d.heat ? 'ON' : 'OFF'
                }));
                const prompt = `Analyze this thermopile sensor data: ${JSON.stringify(sampledData)}. Brief technical report on trends and correlation between heat source and voltage.`;
                const ai = new GoogleGenAI({ apiKey: key });
                const response = await ai.models.generateContent({
                    model: 'gemini-2.5-flash',
                    contents: prompt,
                });
                els.analysisText.textContent = response.text;
                els.analysisContainer.classList.remove('hidden');
            } catch (error) {
                console.error(error);
                alert("Analysis failed.");
            } finally {
                els.btnAnalyze.disabled = false;
                els.btnAnalyzeText.textContent = "Analyze Data with AI";
            }
        };

        // --- VR Integration ---
        
        // Toggle VR Mode
        els.btnEnterVr.onclick = () => {
             document.body.classList.add('vr-active');
             
             // Initialize Chart Texture on Plane
             // We need to wait for A-Frame to init, but since it's just a DOM prop setting:
             els.vrChartPlane.setAttribute('material', 'shader: flat; src: #sensorChart');
             
             // Optional: Request Fullscreen? Usually handled by user gesture or A-Frame VR button.
             // We just show the UI for now.
        };

        els.btnExitVr.onclick = () => {
             document.body.classList.remove('vr-active');
             // Exit fullscreen if active
             if (document.fullscreenElement) document.exitFullscreen();
        };

        // VR Interactions (Attach listeners to A-Frame entities)
        // Note: We must wait for the entities to load, but since we are in module at bottom of body, they exist in DOM.
        
        // Helper to add click listener to A-Frame entity
        function addVrClick(id, handler) {
            const el = document.getElementById(id);
            if(el) {
                el.addEventListener('click', handler);
                // Add hover effect
                el.addEventListener('mouseenter', () => {
                   el.setAttribute('scale', '1.1 1.1 1.1');
                });
                el.addEventListener('mouseleave', () => {
                   el.setAttribute('scale', '1 1 1');
                });
            }
        }

        addVrClick('vr-btn-record', toggleRecording);
        addVrClick('vr-btn-heat', toggleHeat);
        addVrClick('vr-btn-clear', clearData);

    </script>
  <script type="module" src="/index.tsx"></script>
</body>
</html>